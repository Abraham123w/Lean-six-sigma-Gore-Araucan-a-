<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etapa 7: Formalizaci√≥n y Respaldo | GORE Araucan√≠a</title>
    <style>
        :root {
            --primary-color: #1565C0;
            --secondary-color: #424242;
            --success-color: #2E7D32;
            --warning-bg: #FFF8E1;
            --border-color: #ddd;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #F5F5F5;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .stage-badge {
            background-color: var(--primary-color);
            color: white;
            padding: 5px 15px;
            border-radius: 50px;
            font-size: 0.85rem;
            text-transform: uppercase;
            font-weight: bold;
        }

        /* Bloque de Cotizaciones */
        .quote-card {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #fff;
            transition: all 0.3s;
        }

        .quote-card.high-value {
            border-left: 5px solid #FF9800; /* Naranja para > 10 UTM */
            background-color: #fff3e0;
        }

        .card-header {
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        input[type="text"], input[type="number"], input[type="date"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        /* Zona de Archivos */
        .file-zone {
            background-color: white;
            padding: 15px;
            border: 1px dashed #999;
            border-radius: 4px;
        }

        .multi-upload {
            display: none; /* Oculto por defecto */
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .alert-rule {
            font-size: 0.85rem;
            color: #E65100;
            display: none;
            margin-bottom: 10px;
            font-weight: bold;
        }

        /* Checklist Final */
        .checklist-section {
            background-color: #E8F5E9;
            padding: 20px;
            border-radius: 6px;
            margin-top: 30px;
        }

        .check-item {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="checkbox"] {
            transform: scale(1.2);
            cursor: pointer;
        }

        .btn-submit {
            background-color: var(--success-color);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 4px;
            font-size: 1.2rem;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            margin-top: 30px;
            transition: background 0.3s;
        }
        
        .btn-submit:hover { background-color: #1b5e20; }
        .btn-submit:disabled { background-color: #ccc; cursor: not-allowed; }

        .note-source {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <span class="stage-badge">Etapa 7 de 7: Gate "Admisibilidad"</span>
        <h1>Respaldo y Formalizaci√≥n</h1>
        <p>Carga de Cotizaciones (Anexo 5) y Documentaci√≥n Administrativa.</p>
    </div>

    <form id="formalizationForm" onsubmit="return finalizarPostulacion(event)">

        <h3>1. Respaldo Presupuestario (Cotizaciones)</h3>
        <p style="font-size:0.9rem; margin-bottom:20px;">
            El sistema ha detectado los siguientes √≠tems cr√≠ticos desde la Etapa 6. Debe adjuntar el respaldo de mercado.
            <br><span style="color:#d32f2f;">Valor Referencial UTM: $67.000</span>
        </p>

        <div class="quote-card" id="card-1">
            <div class="card-header">
                <span>√çtem: Equipamiento Computacional (Ejemplo)</span>
                <span id="amount-display-1">$0</span>
            </div>
            
            <div class="grid-3">
                <div>
                    <label>Monto Total (CLP) *</label>
                    <input type="number" id="amount-1" placeholder="Ej: 800000" oninput="checkThreshold(1)">
                </div>
                <div>
                    <label>Fecha Cotizaci√≥n *</label>
                    <input type="date" id="date-1" onchange="checkDate(this)">
                </div>
                <div>
                    <label>Proveedor Principal *</label>
                    <input type="text" placeholder="Raz√≥n Social">
                </div>
            </div>

            <div class="file-zone">
                <div class="alert-rule" id="alert-1">
                    ‚ö†Ô∏è ALERTA: El monto supera las 10 UTM. Seg√∫n Anexo 5, debe adjuntar 3 cotizaciones distintas o Certificado de Proveedor √önico.
                </div>
                
                <label>üìÅ Cotizaci√≥n 1 (Seleccionada) *</label>
                <input type="file" required accept=".pdf,.jpg,.png">

                <div class="multi-upload" id="multi-1">
                    <label>üìÅ Cotizaci√≥n 2 (Comparativa) *</label>
                    <input type="file" class="extra-file" accept=".pdf,.jpg,.png">
                    
                    <label style="margin-top:10px;">üìÅ Cotizaci√≥n 3 (Comparativa) *</label>
                    <input type="file" class="extra-file" accept=".pdf,.jpg,.png">
                    
                    <div style="margin-top:10px; border-top:1px solid #ccc; padding-top:5px;">
                        <label>
                            <input type="checkbox" id="unique-1" onchange="toggleUnique(1)"> 
                            Es Proveedor √önico / Exclusivo (Adjuntar certificado)
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <button type="button" style="background:none; border:1px dashed #666; width:100%; padding:10px; cursor:pointer;" onclick="alert('En el sistema real, esto carga autom√°ticamente los √≠tems del Presupuesto (Etapa 6).')">+ Cargar otro √≠tem de presupuesto</button>

        <h3 style="margin-top:40px;">2. Documentaci√≥n Administrativa (Checklist Final)</h3>
        <div class="checklist-section">
            <p class="note-source">Fuente: Manual de Procedimientos (Res. Ex. 169) - Documentos Esenciales</p>
            
            <div class="check-item">
                <input type="checkbox" id="check_cv" required>
                <label for="check_cv">He cargado los CVs del Equipo T√©cnico (Anexo 1) para demostrar capacidad ejecutora.</label>
            </div>
            <div class="check-item">
                <input type="checkbox" id="check_rol" required>
                <label for="check_rol">Certificado de Rol √önico Tributario (RUT) de la instituci√≥n legible.</label>
            </div>
            <div class="check-item">
                <input type="checkbox" id="check_vigencia" required>
                <label for="check_vigencia">Certificado de Vigencia de Personalidad Jur√≠dica (No mayor a 60 d√≠as).</label>
            </div>
            <div class="check-item">
                <input type="checkbox" id="check_anexos" required>
                <label for="check_anexos">Confirmo que los Anexos 1, 2, 3, 4 y 5 est√°n completos y firmados.</label>
            </div>
        </div>

        <button type="submit" class="btn-submit" id="finalBtn">GENERAR POSTULACI√ìN OFICIAL (PDF)</button>

    </form>
</div>

<script>
    const UTM_VALUE = 67000; // Valor aproximado para validaci√≥n
    const THRESHOLD = 10 * UTM_VALUE; // 670.000

    function checkThreshold(id) {
        const amountInput = document.getElementById(`amount-${id}`);
        const display = document.getElementById(`amount-display-${id}`);
        const multiUpload = document.getElementById(`multi-${id}`);
        const alertMsg = document.getElementById(`alert-${id}`);
        const card = document.getElementById(`card-${id}`);
        const extraFiles = multiUpload.querySelectorAll('.extra-file');

        const value = parseInt(amountInput.value) || 0;
        
        // Formato moneda
        display.innerText = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(value);

        if (value > THRESHOLD) {
            // Activar modo > 10 UTM
            multiUpload.style.display = 'block';
            alertMsg.style.display = 'block';
            card.classList.add('high-value');
            
            // Hacer obligatorios los archivos extra (si no es prov √∫nico)
            if (!document.getElementById(`unique-${id}`).checked) {
                extraFiles.forEach(f => f.required = true);
            }
        } else {
            // Desactivar modo > 10 UTM
            multiUpload.style.display = 'none';
            alertMsg.style.display = 'none';
            card.classList.remove('high-value');
            extraFiles.forEach(f => f.required = false);
        }
    }

    function toggleUnique(id) {
        const isUnique = document.getElementById(`unique-${id}`).checked;
        const extraFiles = document.querySelectorAll(`#multi-${id} .extra-file`);
        
        extraFiles.forEach(input => {
            input.disabled = isUnique; // Deshabilitar carga de 3 cotizaciones si es √∫nico
            input.required = !isUnique; // Si es √∫nico, no son requeridas. Si no, s√≠.
        });

        if(isUnique) {
            alert("Atenci√≥n: Deber√° adjuntar el Certificado de Distribuidor Exclusivo en el espacio de la Cotizaci√≥n 1.");
        }
    }

    function checkDate(input) {
        const date = new Date(input.value);
        const today = new Date();
        const diffTime = Math.abs(today - date);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

        if (diffDays > 60) {
            alert("‚ö†Ô∏è Precauci√≥n: La fecha de la cotizaci√≥n tiene m√°s de 60 d√≠as. \n\nEsto es causa frecuente de rechazo por 'Precios no vigentes'. Se recomienda actualizarla.");
            input.style.borderColor = "#FF9800";
        } else {
            input.style.borderColor = "#ccc";
        }
    }

    function finalizarPostulacion(event) {
        event.preventDefault();

        // Validaci√≥n final
        const checks = document.querySelectorAll('.checklist-section input[type="checkbox"]');
        let allChecked = true;
        checks.forEach(c => { if(!c.checked) allChecked = false; });

        if(!allChecked) {
            alert("Debe confirmar todos los puntos del Checklist Administrativo para proceder.");
            return false;
        }

        const btn = document.getElementById('finalBtn');
        btn.innerHTML = "‚è≥ Generando Dossier Digital...";
        btn.disabled = true;

        setTimeout(() => {
            alert("¬°POSTULACI√ìN EXITOSA! \n\nEl sistema ha compilado los 7 pasos en un Expediente Digital Validado. \n\nSe ha reducido la probabilidad de rechazo administrativo en un 90% gracias a las validaciones previas.");
            // Aqu√≠ ir√≠a el submit real
        }, 1500);

        return true;
    }
</script>

</body>
</html>
